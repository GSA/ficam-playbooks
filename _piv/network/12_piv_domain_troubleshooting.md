---
layout: page
collection: piv
title: Troubleshooting PIV Authentication Issues
permalink: piv/network/piv-domain-troubleshooting/
sticky_sidenav: true
sidenav: pivnetwork

subnav:
    - text: Introduction
      href: '#introduction'
    - text: PIV Issues in Kerberos Authentication
      href: '#piv-issues-in-kerberos-authentication'      
    - text: PIV Authentication Errors
      href: '#piv-authentication-errors' 
    - text: Client Issues Preventing Domain Authentication
      href: '#client-issues-preventing-domain-authentication'
    - text: Server Issues Preventing Domain Authentication
      href: '#server-issues-preventing-domain-authentication' 
---

## Introduction

This playbook describes the troubleshooting process for PIV authentication errors to support personnel responsible for resolving PIV access issues.
Background
User authentication in a Windows environment is based on the Kerberos protocol. PIV authentication in a Windows environment leverages a Kerberos extension called PKINIT.

The basic flow of a PKINIT exchange involves four steps:

1. The client sends an Authentication Service Request (“AS-REQ”), which provides a copy of the client public key certificate as well as a signature proving possession of the client private key.
2. The server validates the AS-REQ, including performing full Path Discovery and Validation of the client certificate. If the AS-REQ is valid, the server will provide an Authentication Service Response (“AS-REP”) which includes a Kerberos Ticket Granting Ticket (“TGT”).
3. The client validates the AS-REP. If it is valid, the client extracts the TGT from the message and sends a Ticket Granting Service Request (“TGS-REQ”) to the Domain Controller.
4. The Domain Controller validates the TGS-REQ. If it is valid, a Ticket Granting Service Response (“TGS-REP”) is provided to the client. The client then uses the service ticket in the TGS-REP for workstation access.

![PKInit Flow]({{site.baseurl}}/assets/playbooks/pkinit-flow.png "PKInit Flow")

In this playbook, we focus on issues related to PIV authentication specifically. Therefore, we have focused on just the first two steps of the protocol exchange (AS-REQ and AS-REP).

General information about troubleshooting Kerberos Service authentication can be found here: [Kerberos and LDAP Troubleshooting Tips](https://docs.microsoft.com/en-us/previous-versions/tn-archive/bb463167(v=technet.10)). This playbook identifies the most common authentication issues for PIV authentication in the domain context.

Additional troubleshooting resources can be found here: [Windows Security troubleshooting documentation for Windows Server](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/windows-security-overview). On the left hand side of the page, look for “Kerberos authentication.” The site contains several articles related to general Kerberos problems and solutions.

## PIV Issues in Kerberos Authentication

PIV authentication issues can occur for two basic reasons:

* The client is unable to access the private key or initiate the authentication flow.
* The server is unable to validate the client certificate or process the request.

This playbook identifies common problems for both the client and the server.

## PIV Authentication Errors

The following table provides a reference list of the error messages documented in this playbook and includes links to possible causes and solutions for the issue:

| Error | Section |
| ----- | ------- |
| The PIN is incorrect. Try again. | [ISSUE: Invalid PIN for Smart Card](#invalid-pin) |
| The smart card is blocked | [ISSUE: Smart Card Locked](#card-locked) |
| This smart card could not be used. Additional details may be available in the system event log. Please report this error to your administrator. | [ISSUE: Smart Card Validation Not Enabled](#validation-not-enabled) |
| An untrusted certification authority was detected while processing the smart card certificate used for authentication. | [ISSUE: Common Policy Certificate Not Installed in Trust Store](#common-not-installed) |

## Client Issues Preventing Domain Authentication

In this section, we will identify common client authentication problems and the error logs generated by Windows when these problems occur.

When troubleshooting client authentication issues, it is common for errors to be generated on the client side that are not visible to the administrator. If a user is having difficulty authenticating to the card itself, or the workstation is not configured to support smart card login, then there may not be any errors generated on the authenticating domain controller.

In these cases, support personnel must coordinate with the users to identify the issue. In some cases, support personnel may not have access to the user’s desktop and will rely upon the user to recognize the errors.
To support this scenario, we provide screenshots for common errors that users will see.

When a user has selected smart card login, their login screen will appear as below:

![Smart Card Login Screen]({{site.baseurl}}/assets/playbooks/smart-card-signin.png "Smart Card Login Screen")

### ISSUE: Invalid PIN for Smart Card {#invalid-pin}

When a user enters an incorrect PIN, they will receive the following error:

![Invalid PIN]({{site.baseurl}}/assets/playbooks/invalid-pin.png "Invalid PIN")

This error indicates the user has incorrectly entered their PIN to authenticate to their smart card.

Issue Resolution:

Direct the user to contact their local support desk to have their PIN reset.

### ISSUE: Smart Card Locked {#card-locked}

In some cases, a user may have locked their smart card by entering an invalid PIN too many times. In that event, the user will see this error:

![Card blocked]({{site.baseurl}}/assets/playbooks/card-blocked.png "Card Blocked")

Issue Resolution:

As before, the solution to this issue is for the user’s local help desk to unlock their card and reset the PIN.

### ISSUE: Smart Card Validation Not Enabled {#validation-not-enabled}

 ![Other Error]({{site.baseurl}}/assets/playbooks/other-error.png "Smart Card Validation Error")

This error indicates that smart card validation is not an accepted method of access in a Windows system.

Resolution: Check system settings and event log to ensure that smart card validation has been enabled on the system in question.

## Server Issues Preventing Domain Authentication

In this section, we will identify common client authentication problems and the error logs generated by Windows when these problems occur.

### Trust Store Misconfiguration

#### ISSUE: Common Policy Certificate Not Installed in Trust Store {#common-not-installed}

Scenario: A user receives the following message while attempting to log in: “An untrusted certification authority was detected while processing the smart card certificate used for authentication.”

See the screenshot below for an example:

![Common not installed]({{site.baseurl}}/assets/playbooks/common-not-installed.png "Common not installed")

Cause: The Common Policy CA is not present or cannot be validated on the Active Directory Server.

Issue Resolution:

For the following steps, we recommend having access to the subscriber’s certificate. If it is not possible to get the subscriber’s certificate, any certificate issued from the appropriate certification authority (CA) will work.

1. Ensure correct certificate chain:

2. Use command certutil -scinfo and provide PIN entry until available certificates are shown. View presented certificates to determine association with smart card logon.

3. Open certview for end-user identity cert with smart card logon extended key usage by double-clicking on the certificate.

4. View the path and ensure it is the path desired that chains up to the Federal Common Policy CA, as shown in the following example:

![Chain to common]({{site.baseurl}}/assets/playbooks/chain-to-common.png "Chain to common")

If the certificate does not chain up to the Federal Common Policy CA, there is probably an invalid certificate cached in AD in the certificate chain. To verify that this is the case, follow the steps below:

1. Log in to the domain controller as an enterprise admin. We recommend using the “Run as Administrator” option to ensure that the commands work.

2. Open command prompt as Administrator and enter the following command:

    certutil -enterprise -verifystore NTAuth

3. Identify any certificates in the desired path that are expired or revoked.

   The following screenshot shows a picture of an invalid certificate trust store entry

   ![Expired certificate in trust store]({{site.baseurl}}/assets/playbooks/expired-cert-in-trust-store.png "Expired certificate in trust store")

4. If any certificates are expired, revoked, represent an undesired path, etc., remove them with the following command:

   certutil -enterprise -delstore NTAuth [certificate serial number]

   The following screenshot shows an example:

   ![certutil -delstore example]({{site.baseurl}}/assets/playbooks/certutil-delstore-example.png "certutil -delstore example")

5. Add the root CA for the desired path to the enterprise NTAuthCA and Root CA Stores:
   certutil -dspublish -f [root certificate file] RootCA

   certutil -dspublish -f [root certificate file] NTAuthCA

   certutil -enterprise -addstore NTAuth [root certificate file]

   ![certutil -dspublish example with root]({{site.baseurl}}/assets/playbooks/certutil-dspublish-root.png "certutil -dspublish example with root")

6. Add the remaining intermediate certificates in the path to the enterprise NTAuthCA store

   certutil -dspublish -f [intermediate ca 1 file] NTAuthCA

   certutil -dspublish -f [intermediate ca 2 file] NTAuthCA

   certutil -dspublish -f [intermediate ca x file] NTAuthCA

   ![certutil -delstore example]({{site.baseurl}}/assets/playbooks/certutil-dspublish-intermediate.png "certutil -delstore example")

7. Allow some time (up to 8 hours by default) for the new Active Directory Group Policy update containing the new NTAuth certs to propagate throughout the domain.  
   This can be expedited with the following commands on the end user workstation:  

   gpupdate /force

   certutil -pulse

8. Once the Group Policy has been pushed out to clients, the issue should be resolved.  
